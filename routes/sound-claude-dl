import express from "express";
import fetch from "node-fetch";
import FormData from "form-data";

const router = express.Router();

/** ğŸ§ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† SoundCloud */
async function downloadSoundCloud(url) {
  try {
    const form = new FormData();
    form.append("url", url);
    form.append("token", "");

    const res = await fetch("https://scdler.com/wp-json/aio-dl/video-data/", {
      method: "POST",
      body: form,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        Referer: "https://scdler.com/ar/soundcloud-downloader/",
        Origin: "https://scdler.com",
        "User-Agent": "Mozilla/5.0",
        Accept: "application/json",
      },
    });

    const json = await res.json();

    if (!json || !json.medias || json.medias.length === 0) {
      throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ØµÙˆØªÙŠ.");
    }

    const media = json.medias[0];
    return {
      status: true,
      title: json.title || "Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ",
      quality: media.quality || "ØµÙˆØª",
      size: media.size || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
      audioUrl: media.url,
      thumb: json.thumbnail || null,
    };
  } catch (error) {
    throw new Error(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}`);
  }
}

/** ğŸ“¥ GET Route - ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø±Ø§Ø¨Ø· SoundCloud */
router.get("/", async (req, res) => {
  try {
    const url = req.query.url;
    if (!url || !url.includes("soundcloud.com")) {
      return res.status(400).json({
        status: false,
        message: "âš ï¸ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØª ØµØ­ÙŠØ­ Ù…Ù† SoundCloud ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ (url)",
      });
    }

    const result = await downloadSoundCloud(url);
    res.json({
      status: true,
      message: "âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­",
      result,
    });
  } catch (error) {
    res.status(500).json({
      status: false,
      message: "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† SoundCloud",
      error: error.message,
    });
  }
});

export default router;